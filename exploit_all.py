#!/usr/bin/env python
# -*- coding: utf-8 -*-

import time

from core.exploit.submit_flag import *
from core.exploit.get_flag import *

# change to your team token
# token = "VgHaNNfg"
token = "13"

# change it to error string when submit flag failed
failed = 'err'


def exploit(host, port):
    flag = get_flag(host, port)
    if (submit_flag(flag, token, failed)):
        return 1
    else:
        return 0

def exploit_all():
    num = 0
    with open("targets.txt") as f:
        for line in f:
            host = line.split(":")[0]
            port = int(line.split(":")[1])
            print "------------------------------------------"
            print "[+] Exploiting : %s:%d" % (host, port)
            if(exploit(host, port)):
                num += 1
    return num

def main():
    print colored("[+] Starting attack framework...", 'cyan')
    round_time = 60 * 5
    print colored("[+] Round time : %s seconds..." % (round_time), 'cyan')
    wait_time = round_time / 2
    print colored("[+] Wait time : %s seconds..." % (wait_time), 'cyan')
    while True:
        this_round_flag_num = 0
        this_round_flag_num = exploit_all()
        print "------------------------------------------"
        print "[+] This round is finished, get " + colored(this_round_flag_num, 'green') + " flags, waiting for the next round..."
        while wait_time > 0:
            print "[+] The next attack is %d seconds later..." % (wait_time)
            time.sleep(5)
            wait_time -= 5

if __name__ == "__main__":
    main()